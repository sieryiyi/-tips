https://www.bilibili.com/video/BV13g41157hK?p=12&vd_source=07999cb1d010fa9357b6650a0ee711a7

7.5

### 哈希碰撞

哈希碰撞：不同in，相同out

输出域记为 S 域，创造哈希函数的规则：几乎让 f(in) 均匀分布在S域上

均匀性、离散性：通过哈希函数实现离散

防止内存爆炸：从一张哈希表处理  -----→  利用哈希函数， 变成多张哈希表处理 

扩容逻辑：当某一个value下的链表长度超过某个值时，触发扩容，扩容代价O（log N）

### 布隆过滤器（极大减少内存，用较小的失误换内存）

用于黑名单系统、爬虫去重问题（不希望有线程爬已经爬过的网页）等

↑↑↑↑↑↑↑↑不要求有删除功能的哈希表


不使用布隆过滤器的话，也能解决，但需要非常大的内存

布隆过滤器：允许存在一定的误差

误差：1）黑名单的判成白名单，2）白名单判成黑名单

布隆过滤器不会有第一种情况（即只允许错杀，不允许放过）

#### 位图

基础类型如int，每一个int是4字节、32bit，位图是每一个位置都是 1bit 的数组，可以极大减少内存

1）布隆过滤器首先建立一个非常长的位图，长度为m，每一个需要加入黑名单的东西，经过k个哈希函数，在% m，得到k    个位置，将位图中这些位置置1

2）如果查询时，但凡一个算出来的值不为1，说明这个不在黑名单里

3）m 和 k 定多少很重要

#### 什么时候用布隆

允许有一定失误率p，已知样本量n

1） m= - (n*lnp)/ln(2)**2  理论值

    算出的是需要多少bit位，进而算出字节数

2） k=ln2*m/n ≈ 0.7*m/n     理论值

3） p（真正失误率）=1-e**(-n*k真/m真)**k真

### 一致性哈希原理（解决迁移代价的问题）

用来讨论数据服务器怎么实现的

逻辑服务器一定是负载均衡的

哈希key选择问题，一定要选择种类比较多的，比如姓名，而不是国家

哈希key中的高频、中频、低频如果在每一个数据服务器中都比较均衡，那么说数据服务器是负载均衡的，不能比如总共10个数据服务器，就2个高频key

数据服务器的扩充或者减小：数据迁移的代价非常高（因为是全量迁移），如果每次重新%一遍新的服务器数量

----------------------------

一致性哈希就是解决这个数据迁移问题的！！！！！！！

将哈希域S想象成一个圆，若干个数据服务器通过某种个哈希函数，映射到这个域上，一条数据通过哈希函数算出一个哈希值，在圆上顺时针旋转，遇到的第一个服务器就是归属服务器

逻辑端没有专属数据

如果本来三个服务器，现在加了一个服务器m4，加到m2和m3之间，那只需要把原本在m2和m3间的数据重新哈希，给一部分给m4



存在问题：

    1）机器数量小的时候，可能数据服务器们难以均分，负载不均衡（数据倾斜问题）

    2）即使均分了，加或者减时候，负载均衡被破坏

解决方法：

    虚拟节点：每个服务器尽心多次哈希，生成多个虚拟服务器节点（在S域上）
    
    比如服务器m1，有1000个字符串，这1000个字符串分别哈希，得到1000个哈希值映射到环上，即1000个虚拟节点去抢环
    
    虚拟节点之间的转换数据很方便
